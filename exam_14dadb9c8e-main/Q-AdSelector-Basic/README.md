# Q-AdSelector-Basic

## 問題文
あなたのチームはユーザのセグメントごとに広告を出し分ける機能を開発しています。

ユーザのセグメントは1〜N まで存在し、広告は 1〜Mまで存在します。
セグメントiに属するユーザが広告jをクリックする確率はベルヌーイ分布

```
P(click=1) = Pij
P(click=0) = 1-Pij
```

に従うことが分かってます。ただし 0 <= Pij <= 1 (1 <= i <= N, 1 <= j <= M) は定数で、互いに独立とします。

ユーザのIDが与えられるので、そのユーザに出す広告を選ぶプログラムを作成してください。

ユーザとセグメントの対応表およびこれまでの実績サマリログが CSV ファイルに格納されているのでその情報を活用し、なるべく多くクリックが出るように広告を出し分けてください。

ただし、ユーザのセグメントおよびベルヌーイ分布のパラメータは時間の経過とともに変化しないこととします。

## 入出力形式
この問題はインタラクティブ形式（入力と出力を交互に行うタイプの問題）です。入力は標準入力から与えられます。出力は標準出力に行ってください。バッファリングにより実際の出力が遅延することがあるため、こまめにフラッシュを行うように注意してください。

まずN, Mがスペース区切りで与えられます。

ただし、

1 <= N <= 10  
1 <= M <= 10

です。

そのあと、以下の形式の入力が与えられます。

```
u:x
```

ここで x はユーザのIDで、

1 <= x <= 1,000

です。

ユーザ x に表示する広告を選んで以下の出力を行なってください。

```
a:y
```

ただし、y は広告IDで、

1 <= y <= M

です。

選んだ広告に対して結果が与えられます。

```
c:z
```

zは0か1です。1の場合はクリックされたことを意味します。

上記のクエリ、広告の選択、結果の通知が何度か行われたあと以下の入力が与えられます。

```
bye
```

上記の入力を得た場合はプログラムを終了してください。

クエリの量は問題ケースごとにあらかじめ決められており、各ユーザごとに最大10件のクエリが与えられます。高速にクエリに答えたからといって多くのクエリが飛んでくるわけではありません。

## 入出力例
```
10 10
u:1
a:1
c:1
u:1
a:2
c:0
u:1
a:2
c:1
bye
```

上記の例ではユーザ1に対するクエリのみが与えられています。この例では以下のことが行われています。

```
広告1を選ぶとクリックされた。
広告2を選ぶとクリックされなかった。
再度広告2を選んだところ、今度はクリックされた。
```

## CSVファイル
CSVファイルはプログラム（ `run.sh` ）から見て `./data` というディレクトリに格納されています。各CSVの形式とデータの詳細については以下を参照してください。

### segments.csv
```
ユーザID,セグメントID
```

* ユーザとセグメントの対応表です。
* ユーザIDが1〜1000までの情報がすべて格納されています。

### summary.csv
```
ユーザID,広告ID,表示数,クリック数
```
* これまでの実績サマリログです。
* すべての(ユーザID,広告ID)の組み合わせに対して、これまでそのユーザにその広告を何回表示したのかと何回クリックされたかのデータが格納されています。
* ユーザIDは1〜1000の整数で、広告IDは1〜Mの整数です。同一の（ユーザID, 広告ID）のペアが複数行に含まれていることはありません。
* 表示数は0~10の整数で行ごとに異なります。
* クリック数は問題文で定義されたベルヌーイ分布にしたがってサンプリングをおこなった結果が入っています。

## 参考実装
ランダムに広告を選ぶプログラムを参考実装として公開しています。判定用プログラムの標準入力・標準出力を参考実装プログラムの標準出力・標準入力につなげることでローカル環境でも動かすことができます。


例として Mac OS 環境で動かす場合は以下のようにします。
 
```
$ mkfifo up_pipe
$ mkfifo down_pipe
$ ./run.sh <down_pipe >up_pipe &
$ python server.py --sample_case 1 >down_pipe <up_pipe
prepare sample case data: #1.
start server.
your score=5178.
```

## 提出物
* 作成したプログラムをGitHubにプッシュしてください。
* プログラムはこのファイルが置かれているディレクトリをカレントディレクトリとして、 `./run.sh` で起動できるようにしてください。
* プログラムは以下のパフォーマンス要件を満たすようにしてください。
	* 利用可能メモリ: `1GB`
	* 実行時間: `10s`
		* 最大で `10,000件` のクエリが与えられます。
		* 平均 `1,000 qps` 以上のスループットで処理を行ってください。

## 採点方法
採点は複数のテストケースに対して独立に実行されます。各テストケースごとに基準スコアが決められており、基準スコア以上のクリック数を獲得できた場合のみ、そのテストケースは正解と判定されます。

## ヒント
バンディットアルゴリズムを用いて広告を出し分けるとよいでしょう。

ただし、単純なバンディットアルゴリズム（ε-greedy）では不十分です。Thompson sampling を使うと基準スコアを超えることが出来ますので、よいアイデアが浮かばない場合は Thompson sampling を実装してみるとよいでしょう。

## サンプルケース
いくつかのテストケースをサンプルとして公開しています。`server.py` を実行するときのオプション引数 `sample_case` を変更することでサンプルケースを切り替えることができます。

各テストケースの基準スコアは以下のとおりです。

| sample_case | 基準スコア | 
| :---: | :---: |
| 1 | 9500 | 
| 2 | 8300 | 
| 3 |  7000 | 
| 4 |  8000 | 
| 5 |  9800 | 

## フィードバック
採点時に各テストケースにおいて以下のフィードバック文のいずれかが返されます。

* `実行が完了しました`
	* プログラムが正常に出力を行なったことを表します。
	* **基準スコア以上のクリック数を獲得できたとは限らない**ので注意してください。（正解かどうかはフィードバックには含まれません。）
* `実行時間が制限を超過しました`
	* 処理時間がパフォーマンス要件の制限を超えたことを表します。
* `使用メモリ量が制限を超過しました`
	* 使用メモリ量がパフォーマンス要件の制限を超えたことを表します。
* `出力のフォーマットが不正です`
	* 出力内容のフォーマットが仕様と異なることを表します。
	* 「入出力形式」に記載されている出力の仕様を確認し、プログラムを修正してください。
* `ビルドに失敗しました`
	* プログラムのビルドに失敗したことを表します。
	* `build.sh` の内容が正しいことを確認してください。
* `実行が正常に完了しませんでした`
	* プログラムが正常終了しなかったことを表します。
	* プログラムコードおよび `run.sh` の内容が正しいことを確認してください。
* `サンプルのままの提出です`
   * 用意されたサンプルコードや解答例がそのまま提出されたことを表します。
* `解答ファイルが提出されていません`
   * `run.sh`が提出されていないことを表します。

その他、採点システム上の問題が生じた場合は下記のフィードバック文が返されます。お問い合わせ先にご連絡ください。

* `採点システムにエラーが発生しました`
  * システムのエラーです。お手数ですが本スキルチェックの案内メールに記載のお問い合わせ先にご連絡ください。


